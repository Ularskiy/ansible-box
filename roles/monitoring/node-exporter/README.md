# Ansible Роль: `monitoring/node-exporter`

## Назначение:
Роль устанавливает, обновляет и удаляет Node Exporter на целевых хостах. Используется в мониторинговой системе на базе Prometheus.

## Статус реализации

| Возможность                                    | Статус                   |
|------------------------------------------------|--------------------------|
| Установка Node Exporter                        | Проверено                |
| Удаление Node Exporter                         | Проверено                |
| Проверка и контроль systemd службы             | Проверено                |
| Установка systemd unit через шаблон            | Проверено                |
| Проверка доступности метрик                    | Проверено                |
| Обновление Node Exporter                       | Требуется тестирование   |
| Использование fallback-бинарника               | Требуется тестирование   |
| Работа на разных дистрибутивах (Debian/RedHat) | Требуется тестирование   |
| Интеграция с ролями пользователей/групп        | Проверено                |

## Требуемые модули:
- Ansible Core = 2.14.8
- Python 3.11.2 на Ansible контроллере
- node_exporter 1.9.1 

## Требования 
Для корректной работы роли ноебходимо:
- Существование пользователя и группы, под которыми будет запускаться Node Exporter. 
- Поддержка `systemd` на конечных хостах.
- Доступный для скачивания бинарник `node_exporter` расшаренный через через сетевую шару, указывается через переменную `node_exporter_local_base_url:`

## Переменные

#### Основные переменные

| Переменная              | Тип      | Значение по умолчанию                                   | Назначение                                                   |
|-------------------------|----------|---------------------------------------------------------|--------------------------------------------------------------|
| `node_exporter_version` | string   | `"1.9.1"`                                               | Устанавливаемая версия Node Exporter                         |
| `node_exporter_state`   | string   | `"present"`                                             | `present` (установка) или `absent` (удаление)                |
| `node_exporter_user`    | string   | *(не задано)*                                           | Имя пользователя, не создаётся в рамках роли                 |
| `node_exporter_group`   | string   | *(не задано)*                                           | Имя группы, не создаётся в рамках роли                       |
| `node_exporter_port`    | int      | `9100`                                                  | Порт, на котором будет доступен Node Exporter                |
| `node_exporter_bin_path`| string   | `"/usr/local/bin/node_exporter"`                        | Путь установки бинарника                                     |
| `node_exporter_tmp_bin` | string   | `"/tmp/node_exporter_{{ node_exporter_version }}"`      | Временный путь для скачивания бинарника                      |

### Подробный [пример использования переменных](../../../docs/text/node-exporter/example_use_keys.md)

### Загрузка и fallback (локальный бинарник)

| Переменная                   | Тип    | Значение по умолчанию                                                                 | Назначение                                                                       |
|------------------------------|--------|----------------------------------------------------------------------------------------|----------------------------------------------------------------------------------|
| `node_exporter_local_base_url` | string | `"http://192.168.192.168/soft/monitoring/node_exporter"`                              | URL к локальному архиву Node Exporter                                           |
| `node_exporter_path_in_url` | string | `"node_exporter-{{ node_exporter_version }}.linux-amd64/node_exporter"`              | Относительный путь внутри архива                                                |
| `update_node_exporter`      | bool   | `false`                                                                               | Принудительно обновить даже если бинарник существует                            |
| `use_fallback_node_exporter`| bool   | *(определяется в процессе выполнения, по size если меньше 10MB)*                                | Использовать ли fallback (локальный файл `files/node_exporter_fallback`)        |

### Теги

Поддерживаются следующие теги для запуска выборочных задач:

| Тег         | Назначение                                                                 |
|-------------|----------------------------------------------------------------------------|
| `manual`    | Метка для ручных или потенциально опасных задач                            |
| `dangerous` | Используется вместе с `manual` — например, `systemctl daemon-reexec`       |


## Зависимости

Данная роль **не создаёт** пользователя и группу, а ожидает, что они уже существуют.  
Для этого следует использовать роли:

- [Роль для настройки пользователей](../../infra/manage-users/)
- [Роль для настройки группы](../../infra/manage-groups/)

> Эти сущности не создаются в рамках этой роли - вместо этого предполагается использование вышеперечисленных ролей. Такой подход реализует концепцию мульти-ролевой архитектуры, где **каждая роль делает только одну задачу**, но делает её **хорошо**.