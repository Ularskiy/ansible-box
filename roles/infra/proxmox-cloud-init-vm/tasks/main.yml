- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω–æ–π vm_list
  assert:
    that:
      - vm_list is defined
      - vm_list | length > 0
    fail_msg: "vm_list –Ω–µ –∑–∞–¥–∞–Ω –∏–ª–∏ –ø—É—Å—Ç!"
  tags: [validate]

- name: –í–∞–ª–∏–¥–∞—Ü–∏—è —É–∑–ª–∞
  import_tasks: validate_node.yml
  tags: [validate]

- name: –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤—É—é—â–∏—Ö –í–ú
  import_tasks: check_vm_exists.yml
  tags: [check, clone, delete]

# üëá –í–†–ï–ú–ï–ù–ù–û 
- name: Debug ‚Äî –≤—ã–≤–æ–¥ –ø–æ–ª–Ω–æ–π —Å—Ç—Ä—É–∫—Ç—É—Ä—ã check_vm_result
  debug:
    var: check_vm_result
  tags: [debug]

- name: Debug ‚Äî —Å—Ç–∞—Ç—É—Å —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è –í–ú –∏–∑ check_vm_result
  debug:
    msg: "–í–ú {{ item.item.name }} ‚Üí status: {{ item.status }}"
  loop: "{{ check_vm_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  tags: [debug]

- name: –£–¥–∞–ª–∏—Ç—å –í–ú
  include_tasks: delete.yml
  loop: "{{ check_vm_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.item.state == 'absent'
    - item.status in [200, 500]
  tags: [delete]

- name: –ö–ª–æ–Ω–∏—Ä–æ–≤–∞—Ç—å –í–ú
  include_tasks: clone.yml
  loop: "{{ check_vm_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.item.state in ['present', 'started']
    - item.status in [404, 500]  
  tags: [clone]

- name: –ü–æ–¥–æ–∂–¥–∞—Ç—å —Å–Ω—è—Ç–∏–µ lock
  include_tasks: wait_unlock.yml
  loop: "{{ check_vm_result.results }}"
  loop_control:
    label: "{{ item.item.name }}"
  when:
    - item.item.state in ['present', 'started']
    - item.status in [404, 500] 
  tags: [wait, clone]


- name: –ù–∞—Å—Ç—Ä–æ–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä—ã Cloud-Init
  include_tasks: cloud_init.yml
  loop: "{{ vm_list }}"
  loop_control:
    label: "{{ item.name }}"
  when: item.state in ['present', 'started']
  tags: [cloud_init]

- name: –ó–∞–ø—É—Å—Ç–∏—Ç—å –í–ú
  import_tasks: start.yml
  when: item.state == 'started'
  tags: [start]

- name: –û—Å—Ç–∞–Ω–æ–≤–∏—Ç—å –í–ú
  import_tasks: stop.yml
  when: item.state == 'stopped'
  tags: [stop]

- name: –°–¥–µ–ª–∞—Ç—å —Å–Ω–∞–ø—à–æ—Ç
  import_tasks: snapshot.yml
  when: item.state == 'snapshot'
  tags: [snapshot]

- name: –°–¥–µ–ª–∞—Ç—å –±—ç–∫–∞–ø
  import_tasks: backup.yml
  when: item.state == 'backup'
  tags: [backup]

