# Ansible Роль: `infra/proxmox-cloud-init-vm`

## Назначение:
Эта роль предназначена для управления виртуальными машинами в **Proxmox VE** с помощью API.      
Поддерживает:
- клонирование и настройка cloud-init, 
- добавление и resize дисков, (Не проверена, но логика задана)
- создание снапшотов, бэкапов, удаление ВМ и миграции. (Не проверена, но логика задана)

### Статус реализации

| Возможность               | Статус        |
|---------------------------|---------------|
| Клонирование шаблона      | Работает |
| Cloud-Init (ciuser/ip)    | Работает | 
| Установка SSH ключей      | Работает |    
| Resize основного диска    | Требуется тестирование |
| Добавление дисков         | Требуется тестирование |
| Snapshot / Backup         | Требуется тестирование |
| Миграция между нодами     | Требуется тестирование |


## Требуемые модули:
- Ansible Core = 2.14.8
- Proxmox VE 8.2.2 
- Python 3.11.2 на Ansible контроллере

## Требования 
Роль требует предварительной подготовки:      
**1.** Настроенный пользователь и API-токен в Proxmox    
**2.** SSH-доступ и разрешение на `sudo` без пароля     
**3.** Два SSH-ключа - для подключения к `Proxmox` и для передачи в VM     
**4.** Корректно подготовленный `cloud-init` шаблон     

#### Подробнее [про требования роли можно прочитать тут](../../../docs/text/proxmox-cloud-init-vm/requirements.md)

## Таблица ключей из словаря
|     Ключ           |       Тип        |                Описание                                |
|--------------------|------------------|--------------------------------------------------------|
| `name`             | `string`         | Название ВМ                                            |
| `id`               | `int`            | VMID (уникальный идентификатор ВМ)                     |
| `state`            | `string (enum)`  | Целевое состояние ВМ: `present`, `started`, `absent`, `backup`, `snapshot`, `rollback`, `migrate` |
| `target_node`      | `string`         | Название Proxmox-ноды, на которую будет развернута ВМ  |
| `source_node`      | `string`         | Исходная нода (используется при миграции)              |
| `source_vmid`      | `int`            | VMID шаблона, если отличается от глобального `template_vmid` |
| `ip`               | `string`         | IP-адрес для `cloud-init`                              |
| `cidr`             | `int`            | Маска сети (по умолчанию: `24`)                        |
| `gw`               | `string`         | Шлюз по умолчанию (default: `192.168.100.1`)           |
| `nameserver`       | `string`         | DNS сервер (по умолчанию: `8.8.8.8`)                   |
| `searchdomain`     | `string`         | DNS-домен (по умолчанию: `local`)                      |
| `ci_user`          | `string`         | Пользователь, создаваемый через cloud-init             |
| `memory`           | `int` (MB)       | Объём оперативной памяти                               |
| `cores`            | `int`            | Количество CPU                                         |
| `onboot`           | `bool/int`       | Включать ли ВМ при запуске хоста (`1` / `0`)           |
| `disk_add`         | `dict`           | Добавляемый диск. Пример: `{storage: "local-lvm", size: "10G"}` |
| `disk_resize`      | `int` (GB)       | Увеличить существующий диск на указанное количество ГБ |
| `disk_name`        | `string`         | Название диска для resize (например, `scsi0`)          |
| `bridge`           | `string`         | Имя сетевого моста, например `br-vlan0000`             |
| `nic_model`        | `string`         | Тип сетевого интерфейса (`virtio`, `e1000`, и др.)     |
| `snapshot_name`    | `string`         | Название снапшота (для snapshot/rollback)              |
| `backup_storage`   | `string`         | Название стораджа, куда делается бэкап                 |

### Подробный [пример использования ключей](../../../docs/text/proxmox-cloud-init-vm/example_use_keys.md)

## Поддерживаемые теги 
| Тег           | Описание                                      |
|----------------|-----------------------------------------------|
| `validate`     | Проверка входных переменных и ноды            |
| `check`        | Проверка существующих ВМ                      |
| `clone`        | Клонирование шаблона                          |
| `cloud_init`   | Настройка параметров cloud-init               |
| `delete`       | Остановка и удаление ВМ                       |
| `disk`         | Работа с дисками                              |
| `add_disk`     | Добавление нового физического диска           |
| `resize_disk`  | Расширение существующего диска                |
| `net0`         | Настройка сетевого интерфейса (bridge + model)|
| `start`        | Запуск ВМ                                     |
| `stop`         | Остановка ВМ                                  |
| `snapshot`     | Создание снапшота                             |
| `backup`       | Создание резервной копии                      |
| `rollback`     | Откат ВМ к снапшоту                           |
| `wait`         | Ожидание unlock/выключения                    |
| `debug`        | Вывод статуса ВМ для отладки                  |

### Подробный [пример использования тегов](../../../docs/text/proxmox-cloud-init-vm/example_use_tags.md)