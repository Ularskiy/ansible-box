# Ansible Роль: `infra/manage-users`

## Назначение:
Роль предназначена для создания, обновления, удаления и управления пользователями Linux в системах, поддерживающих getent, useradd, usermod, sudo, и systemd. Поддерживает создание учётных записей, установку паролей, настройку sudo, dry-run, защиту от удаления системных пользователей и логирование событий.

### Статус реализации

| Возможность                                                      | Статус                 |
|------------------------------------------------------------------|------------------------|
| Создание новых пользователей                                     | Работает               |
| Удаление пользователей                                           | Работает (с защитой)   |
| **Проверка активных процессов**                                  | Работает               |
| Управление существующими пользователями                          | Работает               |
| Установка shell, comment, групп                                  | Работает               |
| Настройка `sudo` (три режима)                                    | Работает               |
| Поддержка ограниченного sudo                                     | Работает               |
| **Установка пароля** с подтверждением при создании пользователя  | Работает               |
| Поддержка DRY-RUN                                                | Работает               |
| Проверка UID / GID / конфликтов                                  | Работает               |
| Логирование через `shared/log-events`                            | Не дописан             |
| Поддержка remove_from_groups                                     | Работает               |
| Подтверждение удаления чувствительных пользователей              | Работает               |

## Требуемые модули:
- Ansible Core = 2.14.8
- Proxmox VE 8.2.2 
- Python 3.11.2 на Ansible контроллере

### Основные переменные
| Переменная             | Тип            | Значение по умолчанию   | Описание                                              |
|------------------------|----------------|-------------------------|-------------------------------------------------------|
| `users`                | `list`         | `[]`                    | Основной список пользователей                         |
| `protected_users`      | `list`         | `[]`                    | Список имён пользователей, удаление которых запрещено |
| `sensitive_accounts`   | `list`         | `[]`                    | Требуют ручного подтверждения перед удалением         |
| `users_dry_run`        | `bool`         | `false`                 | Активирует режим DRY-RUN                              |
| `default_shell`        | `string`       | `/bin/bash`             | Shell по умолчанию                                    |
| `sudoers_file`         | `string`       | `/etc/sudoers.d`        | Директория для sudo-конфигураций                      |

### Ключи в словаре `users`
| Ключ                | Тип            | Описание                                                            |
|---------------------|----------------|---------------------------------------------------------------------|
| `name`              | `string`       | Имя пользователя (обязательно)                                      |
| `uid`               | `int`          | UID пользователя (опционально)                                      |
| `gid`               | `int`          | GID пользователя (опционально)                                      |
| `shell`             | `string`       | Shell пользователя                                                  |
| `groups`            | `list`         | Дополнительные группы                                               |
| `comment`           | `string`       | Комментарий (GECOS)                                                 |
| `state`             | `string`       | `present` / `absent`                                                |
| `sudo`              | `string`       | Режим `with_password`, `no_password`, `limited`, `none`             |
| `allowed_commands`  | `list`         | Разрешённые команды для `limited` sudo                              |
| `manage_existing`   | `bool`         | Управлять существующими пользователями                              |
| `remove_groups`     | `list`         | Удалить пользователя из указанных групп                             |            
| `reset_password`    | `bool`         | Принудительно сбросить пароль с ручным вводом и подтверждением      |

### Подробный [пример использования ключей и переменных](../../../docs/text/manage-users/example_use_keys.md)

### Поддерживаемые теги
| Тег         | Назначение                                       |
|-------------|--------------------------------------------------|
| `dry-run`   | Для задач эмуляции (если `users_dry_run` = true) |
| `manual`    | Метка для ручных шагов (например, pause)         |
| `validate`  | Проверка значений и параметров пользователей     |

### Поддерживаемые режимы настройки `sudo`
Поддерживаются три режима настройки прав `sudo`, которые задаются через ключ sudo в словаре пользователя:

| Режим `sudo`     | Назначение                                                                  |
|------------------|-----------------------------------------------------------------------------|
| `with_password`  | Требуется ввод пароля при использовании `sudo`                              |
| `no_password`    | Использование `sudo` без ввода пароля (`NOPASSWD:ALL`)                      |
| `limited`        | Разрешено выполнение только указанных команд без пароля (`NOPASSWD: CMD`)   |



### Рекомендации и предостережения
- Роль **не удаляет пользователя**, если у него есть **активные процессы**. Это сделано **в целях безопасности** — чтобы избежать поломки важных сервисов. По моей логике если есть активные процессы у пользователя, то это требует человеческого вмешательство. Есть идеи реализовать удаление активных процессов с помощью флага с полным согласием и принятием рисков, но пока в этом необходимости нет.
- Например в роли [monitoring/node-exporter](../../monitoring/node-exporter/) завершаются активный процессы принудительно, при удалении пользователя. Это специфическая реализация реализовано на стороне роли `monitoring/node-exporter`, а значит он завершает только свой процесс в рамках логики роли. Если там будут **посторонние активные процессы**, например: `zabbix-agent` который устанавливался в ручную, то в данном случае удаление пользователя не сработает.